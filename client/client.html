<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Charge</title>
    <style>
        * {margin:0;padding:0;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;}
        body {background:orange;display:block;width:100%;}
        header {width:100%;text-align:center;margin:10px 0; font-size:20px;}
        header > h1 {margin:10px;}
        header > h2 {margin:10px;}
        header > a { text-decoration:none; display:inline-block; font-weight:bold; background:#000; color:#fff;padding:5px 10px; }
        .area {display:block; margin:20px 0;}
        .row {display:table;margin:0 auto;}
        .col {float:left;display:block;height:10px;width:10px;background:black;}

    </style>
</head>
<body>
    <header>
        <h1>CHARGE</h1>
        <h2 class="status">CONNECTING..</h2>
        <a class='connect' href="#">REQUEST TO PLAY</a>
    </header>
    <div class="area">
    
    </div>
    <script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
    <script>
    var settings = {};
    settings.socket = io.connect('http://172.17.51.96:2424');
    settings.game = new Game(settings.socket);
    settings.status = document.querySelector('.status');
    settings.status.innerHTML = 'CONNECTED';
    settings.request = document.querySelector('.connect');
    settings.colors = {
        'empty': '#222',
        'wall': 'black',
        'red': 'red',
        'blue': 'blue',
        'green': 'green',
        'orange': 'orange',
        'darkred': 'darkred',
        'darkblue': 'darkblue',
        'darkgreen': 'darkgreen',
        'darkorange': 'darkorange',
    };

    settings.binds = [];
    settings.binds[37] = 'W';
    settings.binds[38] = 'N';
    settings.binds[39] = 'E';
    settings.binds[40] = 'S';
    settings.binds[65] = 'W';
    settings.binds[87] = 'N';
    settings.binds[68] = 'E';
    settings.binds[83] = 'S';
    settings.binds[72] = 'W';
    settings.binds[75] = 'N';
    settings.binds[76] = 'E';
    settings.binds[74] = 'S';
    
    settings.opposite = [];
    settings.opposite['N'] = 'S';
    settings.opposite['S'] = 'N';
    settings.opposite['E'] = 'W';
    settings.opposite['W'] = 'E';

    settings.request.onclick = function(e){
        e.preventDefault();
        settings.game.requestPlaying();
    }

    function Game(socket){
        var self = this;
        this.status = '';
        this.dir = 'N';
        this.socket = socket;
        this.grid = [];
        // Listen to all events
        this.socket.on('receive_grid', function(data){
            console.log(data.rows, data.cols);
            var r;
            var c;
            for (r=0;r<data.rows;r++){
                self.grid[r] = [];
                var row = document.createElement('div');
                row.classList.add('row');
                row.classList.add('row'+r);
                for (c=0;c<data.cols;c++){
                    self.grid[r][c] = document.createElement('div');
                    self.grid[r][c].classList.add('col');
                    self.grid[r][c].classList.add('col'+c);
                    row.appendChild(self.grid[r][c]);
                    self.grid[r][c].style.background = settings.colors['empty'];
                }
                document.querySelector('.area').appendChild(row);
            }
        });

        this.socket.on('receive_status', function(data){
            self.status = data.status || '';
            if (self.status == 'ended')
                self.status = '';

            if (self.status == '' || self.status == 'ended')
                settings.request.style.display = 'inline-block';
            else 
                settings.request.style.display = 'none';

            if (self.status == 'countdown')
                self.dir = 'N';
            settings.status.innerHTML = self.status.toUpperCase();
            console.log(self.status);
        });
        

        this.socket.on('receive_identifier', function(data){
            document.body.style.background = data.color;
        });

        this.socket.on('updateTiles', function(data){
            console.log(data);
            for (var i=0;i<data.tile.length;i++){
                var tile = data.tile[i];
                var color = (settings.colors[tile.value]) ? settings.colors[tile.value] : 'white';
                self.grid[tile.row][tile.col].style.background = color;
            }
        });


        document.onkeydown = function(e){
            if (self.status == 'started'){
                var directionUpdate = self.dir;
                if (settings.binds[e.keyCode])
                    directionUpdate = settings.binds[e.keyCode];
                if (settings.opposite[directionUpdate] == self.dir)
                    return
                self.dir = directionUpdate;
                self.socket.emit('changeDirection', {direction: directionUpdate});
            }
        }

        this.requestPlaying = function(){
            console.log(this.status);
            if (this.status == '' || this.status == 'ended')
                this.socket.emit('request_playing');
        };

        // Request the grid to start playing
        this.socket.emit('request_grid');
    }
    </script>
</body>
</head>
